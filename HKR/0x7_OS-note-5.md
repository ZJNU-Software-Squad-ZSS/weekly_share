# 5. 设备管理

## 5.1 磁带与磁盘存储的特点



## 5.2 I/O系统中的信息传输控制方式

设备管理的主要任务之一是控制设备与内存或CPU之间的数据传送。

主要有以下四种控制方式：

1. 程序直接控制方式（轮询方式）

   适用于简单的、外设很少的计算机系统，缺点耗费大量的CPU时间，且设备和CPU、设备和设备之间只能串行工作，现在已较少使用

2. 中断控制方式

   引入了中断机构，在某种程度上使CPU摆脱了等待I/O设备空转现象，主机和外设可并行工作，提高了主机的利用率。缺点中断次数多，每次中断都要作现场保护和恢复工作，系统开销大，占据CPU时间仍然较多，且能并行操作的设备的台数也受到中断处理时间的限制。

3. DMA方式

   采用了外存与内存直接交换数据的方式。只有在一段数据传送结束时，才发出中断信号要求CPU做善后处理，从而大大减少CPU的负担。

4. 通道方式

   通道也称为I/O处理机，在通道机构中含有通道指令，每一条通道命令规定了设备的一种操作，由通道指令可构成指挥外设工作的通道程序。它采用了外设和内存直接交换数据的方式。

   DMA方式与通道方式的区别在于：DMA方式要求CPU执行设备驱动程序启动设备，给出存放数据的内存起始地址以及操作方式和传送字节长度等；通道则是在CPU发出I/O启动命令后，由通道程序来完成这些工作。

   





## 5.3 中断处理过程

中断处理过程：一旦CPU响应中断，转入中断处理程序，系统就开始进行中断处理，过程为：

1. CPU检查响应中断的条件是否满足，如果条件不满足，则中断处理无法进行。

2. 如果CPU响应中断，则CPU关中断，使其进入不可再次响应中断的状态。

3. 保存被中断进程现场。

4. 分析中断原因，调用中断处理子程序。在多个中断请求同时发生时，处理优先级最高的中断源发出的中断请求。

5. 执行中断处理子程序。

6. 退出中断，恢复被中断进程的现场或调度新进程占据处理机。

7. 开中断，CPU继续执行。

   





## 5.4 缓冲技术

#### 引入缓冲的目的

在设备管理中，引入缓冲的原因可归结为：

1.  缓和CPU和I/O设备间速度不匹配的矛盾
2. 减少中断CPU的次数，放宽对中断响应的要求
3. 提高CPU、通道和I/O设备间的并行性，从而使系统的资源利用率及吞吐量增高。

   

#### 分类

   缓冲按组织方式可分为单缓冲、双缓冲、多缓冲及缓冲池。

1. 单缓冲

   是OS提供的一种最简单的缓冲。其缓冲区是临界资源，即不允许多个进程同时对一个缓冲区操作，因此，设备和设备之间不能通过单缓冲达到并行操作。

2. 双缓冲

   解决两台外设、打印机和终端之间并行的操作问题的办法是设置双缓冲。当二者速度相差太大时，则速度较快的一方将需要等待，而实际计算机系统中，外设间的速度通常相差甚远。所以，现代计算机系统一般使用循环缓冲或缓冲池结构。

3. 多缓冲

   把多个缓冲区连接起来组成两部分，一部分专门用于输入，另一部分专门用于输出的缓冲结构。

   多缓冲的缓冲区是系统的公共资源，可供各个进程共享，并由系统统一分配和管理。

   在LINUX系统中，无论是块设备还是字符设备，都使用多缓冲技术。

4. 缓冲池

   多缓冲仅适用于某个特定的I/O进程和计算进程，因而属于专用缓冲。当系统较大是，将会有许多这样的循环缓冲，不仅需要消耗大量的内存空间，而且利用率也不高。

   为了提高缓冲区的利用率，目前广泛流行的方式是采用公共缓冲池，池中的缓冲区可供多个进程共享。

   缓冲池是把多个缓冲区连接起来统一管理，既可用于输入又可用于输出的缓冲结构。





## 5.5 设备分配

#### 设备独立性

在计算机系统中，可以配置的外设品种繁多。而且在小型机以上的计算机系统中，可以同时接入多台同样的外设。为了便于对这些外设进行管理，系统对每台进入计算机系统中的设备都给定一个对应的编号，作为调用时识别和区分设备用。这种编号无任何重复，一般被称为设备的绝对号（或物理设备名）。



#### 设备分配算法的数据结构

1. 系统设备表SDT

   在SDT表中，每个接入系统中的外围设备都占有一个表目项。登录了该设备的名称、标识及设备控制表DCT的入口地址等相关的信息。

2. 设备控制表DCT

   设备的各方面特征，以及与该设备相连的I/O控制器的情况。

3. 控制器控制表COCT

   反映I/O控制器的使用状态以及和通道的连接情况等（在DMA方式时，该项是没有的）。

4. 通道控制表CHCT 

   反映了通道的情况





## 5.6 移臂调度算法

1. 先来先服务查找算法FCFS

   只考虑对磁盘请求的先后次序，而不考虑访问的物理位置，所有对磁盘有I/O请求的进程先去等待队列中排队，排在前的先给予服务。

2. 最短查找时间优先的算法SSFT

   总是选择请求队列中离当前磁头所在柱面最近的下一个柱面作为即将访问的对象，而不管请求访问者到达请求队列的先后次序。

3. 扫描算法(SCAN)

   在SSTF算法中只考虑了请求访问的柱面与磁头当前所处位置的距离，而不考虑磁臂的移动方向。而SCAN算法则既要考虑距离，也要考虑方向，且方向优先考虑。SCAN算法在选下一个访问者时，先选与磁臂移动方向一致的访问请求，在此基础上，选出与磁头当前柱面最近距离的柱面作为下一个访问对象。此方法与自然界中电梯工作的方式极为相象，故也称“电梯调度”算法。

4. N步扫描(N-Step-SCAN)

   N步扫描与循环算法的服务方式与SCAN方法一致，但它们在向外或向内的移动过程中，只对在磁头改变方向以前已提出申请的访问请求作出服务，新到达的访问请求本次不予访问，留待下次再服务。

5. 循环扫描（C－SCAN)  Circular SCAN

   循环扫描法也称单向扫描，它对请求者的服务总是每次从０柱面号开始，然后移动至最大柱面。遇着访问进行服务。一次完后，磁头再次返回０号柱面，又重复上述步骤。

6. Look调度算法

    类似SCAN算法，但是每次服务的时候，如果没有请求则磁头不用回到最小或最大的磁道号。

7. C－Look调度算法

   类似C－SCAN算法，只会单向地服务之后，立即再由磁盘开头处开始服务。