# 第四章 网络层
### 虚电路和数据报网络
虚电路(VC)网络提供面向连接的服务
数据报网络提供了无连接的服务
##### VC
**组成**
源到目的主机的路径
VC号路径上每段链路一个号码
路径上的路由器中的转发表
**注意**
分组的VC号在经过一条链路时可能发生变化，新的VC号可能替代旧VC号
虚电路建立-数据传输-虚电路删除，中间路由需要维护进行中的连接（增删转发表）
##### 数据报网络
**组成**
转发表
路由算法
**目的地之最长匹配**
一个路由不同的输出链路对应不同的目的地址范围（110101XXXX）
目的地址范围-输出链路 就是路由的转发表
转发表每几分钟由路由算法更新一次
IP地址和几个地址范围进行最长前缀匹配，匹配成功后转发
**注意**
没有端到端连接
由于路由算法更新，相同源-目的地址的数据包的转发路径也可能不同
### 路由结构
路由的关键功能
1、运行路由算法可协议
2、从入端口到出端口链路，前向转发数据报
##### 基本结构
多个输入端口
多个输出端口
路由器处理器
交换结构——上面三个和他相连
##### 输入端口
将光电信号转化成比特流，比特流还原成帧，帧里提取出数据报
实现数据链路层功能
使用数据报的目的地址和前向转发表查找输出端口（排队），转发表由处理器更新并复制给输入端口
##### 交换结构
将输入端口的数据报传输给输出端口
三种类型
**内存交换**
最简单，最早
交换是在CPU的控制下完成的
受到内存带宽限制
**总线交换**
输入端口通过一条总线传输给输出端口
由于存在总线竞争，所以受到总线速度的限制，但挺快了
**crossbar交换**
输入端口和输出端口形成复杂的网络结构(Banyan网络等
##### 输出端口
若数据报到达过快，需要进行排队、缓存(超过上限丢包
有调度策略，选择哪个数据报优先传送（先来先到或者按权传送
### IP协议
##### IP数据报格式
至少20bytes TCP协议里也有20bytes
IP版本号 4bit IPv4或IPv6
首部长度 4bit 确定实际数据部分从哪里开始
服务类型 8bit
数据报长度 16bit 指首部+实际数据的长度，字节为单位

数据报编号 16bit
标识位和偏移量16bit

寿命长度 8bit 每经过一个路由器减一，为0时被丢弃
上层协议 8bit 指明传输层的协议，传送到目的地时被使用
校验和 16bit 头部校验和 路由器使用头部校验和检查数据报头部

源IP地址 32bit  
目的地IP地址 32bit
扩展部分 一般不用

数据部分 包括传输层的报文段(TCP，UDP
##### IP分片&重组
链路层帧能承载的最大数据量称为最大传输单元
链路层协议不同，其最大传输单元不同
大的IP数据报分片成多个小的数据报，在目的地里重组
![](_v_images/20200327145838711_14548.png =400x)
标志位标识是否为最后一个分片
offset标识分片在原数据报的位置
### IP地址
IP地址是指主机/路由器其接口的标识，32bit
格式a.b.c.d一般每个数字8bit
一个路由器有多个接口，1个主机只有一个接口
**子网**
IP地址a，b，c相同的处于一个子网，一般物理上直接相连
如主机-路由的两个接口处于一个子网
##### CIDR
无类别域间选路
格式a.b.c.d/x 32-x为子网部分的位数，x为非子网的IP地址块
##### 主机获取IP地址
网络管理员手动分配
或**DHCP**动态主机配置协议
主要用于获取子网的IP，比如笔记本电脑在不同的网络下获取IP地址
##### 路由汇聚
![](_v_images/20200327160359511_18326.png =400x)
ICANN组织 分配地址给ISP、管理DNS、解决纠纷
##### NAT协议
完成外网和内网地址的转换
**特点**
所有设备只使用一个外部IP地址(整个32位的），形成内部网络（一般192,10,172开头）
更换外部IP地址不需要更换内部
内部设备对外部不可见
**过程**
对于输出的数据报，查看源IP地址和源端口号更改为源IP地址和新端口号，把该次替换记录放入NAT表中，传回时查表替换回来
**穿越问题**
静态配置内网-外网端口映射
UPnP
使用中继
### ICMP协议
用于主机和路由器交换网络层协议
错误报告：不可达主机，网络，端口，协议
放置于IP数据报的数据部分
### IPv6
128bit长度的地址
**结构**
版本号 6bit
流量类型 6bit
流标签 20bit
有效载荷长度 16bit 数据部分
下一首部 8bit 标识上层协议
寿命长度8bit
源、目标地址，各128bit
**IPv4迁移IPv6**
隧道：IPv6的路由遇到IPv4时，将IPv6的整个数据封装在IPv4数据报里，到下次遇到IPv6的路由时再打开
### 路由算法
##### Link-state算法
链路状态选路算法，要求网络拓扑和所有的链路费用已知
就是Dijkstra's算法
##### Network Layer算法
距离矢量算法 
局部的路由算法，每个节点只知道相邻的结点的费用
就是Bellman-Ford算法
##### 层次路由
路由规模过大，直接使用算法不可解
同时每个管理员希望自己管理路由
将路由器组织进自治系统（AS），一个自治系统运行一种intra-AS协议
向其他AS发送分组的路由器称为网关路由器（使用inter-AS协议
内部找最短的可用网关路由，网关路由再找到目标AS网关路由的最短路径
### Internet 的路由
内部网关协议 IGP
常用intra-AS：RIP、OSPF
##### RIP
RIP的通告封装在UDP里
使用 Network Layer，简化了相邻路由之间的距离关系，经过一个路由器记为1跳（包括自己
每个路由记录到某子网的最少跳数以及该路径的下一路由
(比如到x子网，5跳，下一路由为A）
若相邻路由通告更新了到某子网的最少跳数，(路由B到x子网，2跳，下一路由为C）
则会尝试更新自己的转发表（到x子网，3跳，下一路由为B）
**错误**
相邻的路由每30秒通信一次，若超过180秒通信失败，认为该链路中断
向其他相邻路由发送通告
##### OSPF
OSPF的通告封装在IP里
使用Dijkstra算法，所以使用在高层ISP里，每个节点知道本层次网络的拓扑
支持路由层次化
##### BGP
BGP是AS之间进行选路的协议
使用TCP来交换信息





